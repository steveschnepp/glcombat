#include <stdio.h>
#include <gd.h>

int main(int argc, char **argv) {

	if (argc < 4) return -1;

	gdImagePtr im = gdImageCreateFromFile(argv[1]);
	FILE* f = fopen(argv[2], "w");

	int scale = (argc > 2) ? atoi(argv[3]) : 12;

	int max_x = gdImageSX(im);
	int max_y = gdImageSY(im);
	fprintf(f, "%d %d 2.0 2.0", max_x, max_y);
	fprintf(f, "\n");

	for (int i = 0; i < max_x; i ++) {
		for (int j = 0; j < max_y; j ++) {
			int p = gdImageGetTrueColorPixel(im, i, j);

            float h = p * 1.0  / (__UINT32_MAX__ >> scale) ;

			fprintf(f, " %f", h);
		}
		fprintf(f, "\n");
	}
}

/**
8 8 1.0 1.0
 0.500000 0.499998 0.499969 0.499844 0.499506 0.498795 0.497502 0.495376
 0.499998 0.499992 0.499952 0.499807 0.499443 0.498697 0.497362 0.495185
 0.499969 0.499952 0.499877 0.499674 0.499229 0.498379 0.496917 0.494591
 0.499844 0.499807 0.499674 0.499375 0.498795 0.497772 0.496099 0.493525
 0.499506 0.499443 0.499229 0.498795 0.498026 0.496761 0.494793 0.491872
 0.498795 0.498697 0.498379 0.497772 0.496761 0.495185 0.492839 0.489474
 0.497502 0.497362 0.496917 0.496099 0.494793 0.492839 0.490033 0.486128
 0.495376 0.495185 0.494591 0.493525 0.491872 0.489474 0.486128 0.481588
*/